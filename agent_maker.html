<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Agent Maker</title>
    <!-- Needed for macromaker API authentication. -->
    <script src="https://api-dot-macromaker.googleplex.com/empty.js"></script>
    <style>
      h1 {
        color: red;
      }
      p {
        color: blue;
      }
    </style>
  </head>
  <body>
    <section class="dialog-section">
      <ul class="messages"></ul>
    </section>
    <section class="user-prompt-section">
      <textarea class="user-prompt" name="user-prompt" rows="4" cols="50" placeholder="@agent Your request"></textarea>
    </section>
    <div id="debug"></div>
  </body>
  <script>
    (async () => {
      const runMacroEndpointUrl =
        "https://api-dot-macromaker.googleplex.com/run-macro";

      function participatingAgentNames() {
        return "";
      }

      function participatingAgentDescriptions() {
        return "";
      }

      /**
       * A message from an agent has the general form of
       *     @Recipient Message body
       * This function strips the @Recipient part and return the message body.
       * @param {string} message is the original message sent from an agent.
       * @returns {string} just the message body without the recipient
       * annotation.
       */
      function stripRecipientFromMessage(message) {
        const match = message.match(/@.*?\s*(.*)/);
        if (!match) {
          return message;
        }
        return match[1];
      }

      class Agent {
        /**
         * ID of the macro.
         * @type {string}
         */
        macroId = "";

        /**
         * Name of the agent.
         * @type {string}
         */
        name = "NoName";

        /**
         * Self introduction of the agent's capabilities.
         * @type {string}
         */
        selfIntroduction = "I can do nothing. Do not ask me anything.";

        /**
         * Ongoing discussion.
         * ID of the macro.
         * @type {string}
         */
        ongoingDiscussion = "";

        /**
         * @param {string} macroId - ID of the macro
         */
        constructor({ macroId }) {
          this.macroId = macroId;
        }

        /**
         * Initialize some basic agent information so that other agents can
         * discover this agent.
         */
        async init() {
          const namePromise = this.accepts({
            user: "SYSTEM",
            request: "What is your name?",
            temperature: 0.7,
          }).then(stripRecipientFromMessage);

          const selfIntroductionPromise = this.accepts({
            user: "SYSTEM",
            request: "What can you do?",
            temperature: 0.7,
          }).then(stripRecipientFromMessage);

          const { user, selfIntroduction } = await Promise.all([
            namePromise,
            selfIntroductionPromise,
          ]);
          this.user = user;
          this.selfIntroduction = selfIntroduction;
        }

        /**
         * @param {string} user User ID of the sender
         * @param {string} request message of the user
         * @returns {string} the next message
         */
        async accepts({ user, request, temperature = 0.7 }) {
          const inputKey = {
            ongoing_discussion: "14",
            user: "12",
            request: "2",
          };
          const userInputs = {
            [inputKey.user]: user,
            [inputKey.request]: request,
            [inputKey.ongoing_discussion]: this.ongoingDiscussion,
          };

          const formData = new FormData();
          formData.append("id", this.macroId);
          formData.append("userInputs", JSON.stringify(userInputs));
          formData.append("temperature", temperature);

          const response = await fetch(runMacroEndpointUrl, {
            credentials: "include",
            method: "POST",
            body: formData,
          }).then((res) => res.json());

          console.log(`${user}: ${request}\nResponse:`);
          console.log(response);

          for (let message of response.messages) {
            const bestResponse = message.text;
            const noHallucinationResponse = bestResponse.replace(
              /[\n\r\s]*\{FROM:.*/,
              ""
            );
            this.ongoingDiscussion += `\n{FROM:${user}}: ${request}`;
            this.ongoingDiscussion += `\n{THOUGHT}: ${noHallucinationResponse}`;

            const match = noHallucinationResponse.match(/\{SEND\}: (.*)/);
            if (match) return match[1];
          }
          throw new Error(
            "Unable to get agent to return a response with {SEND}."
          );
        }
      }

      const agentBob = new Agent({ macroId: "pxdS6zCRJnMGhe2nYaPJ" });
      await agentBob.init();
      const message = await agentBob.accepts({
        user: "Lawrence",
        request: "What is twice the age of Tom Cruise?",
      });

      const responseDiv = document.getElementById("debug");
      responseDiv.innerHTML = `
        <div>${agentBob.name}</div>
        <div>${agentBob.selfIntroduction}</div>
        <div>${agentBob.ongoingDiscussion}</div>
        <div>${message}</div>`;
    })();
  </script>
</html>
